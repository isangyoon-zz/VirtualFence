<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">

  <title>VirtualFence</title>

  <script>
    window.$ = window.jQuery = require('jquery');
    window.gmap3 = require('gmap3');
    window.MongoDB = require('mongodb');
    window.assert = require('assert');
  </script>

  <style>
    @import url('http://fonts.googleapis.com/earlyaccess/jejugothic.css');
    html, body {margin: 0; width: 100%; height: 100%;}
    body {font: 12px/14px 'Jeju Gothic', sans-serif;}

    #map {display: block; width: 100%; height: 100%;}
  </style>

</head>
<body>
  <div id="map"></div>

  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=drawing,geometry"></script>

  <script>
    $('#map').gmap3({
      zoom: 18,
      center: [36.94929, 127.90739],
      options: {
        disableDefaultUI: true
      }
    }).once({
      idle: () => {
        let findFence = (database, callback) => {
          let cursor = database.collection('fence').find();
          cursor.each((error, document) => {
            assert.equal(error, null);
                    if(document !== null)
                    {
                      let uid     = MongoDB.ObjectID(document._id).toString(),
                          safety  = document.safe,
                          warning = document.warn,
                          danger  = document.danger;
                      let safetyLayer = new GeoJSON(safety, {
                          "strokeColor": "#66cd00",
                          "strokeOpacity": 1,
                          "strokeWeight": 1,
                          "fillColor": "#66cd00",
                          "fillOpacity": 0.35,
                          "zIndex": 5,
                          "map": $scope.mapControl.getGMap()
                        }),
                        warningLayer = new GeoJSON(warning, {
                          "strokeColor": "#ff4500",
                          "strokeOpacity": 1,
                          "strokeWeight": 1,
                          "fillColor": "#ff4500",
                          "fillOpacity": 0.35,
                          "zIndex": 4,
                          "map": $scope.mapControl.getGMap()
                        }),
                        dangerLayer = new GeoJSON(danger, {
                          "strokeColor": "#ff0000",
                          "strokeOpacity": 1,
                          "strokeWeight": 1,
                          "fillColor": "#ff0000",
                          "fillOpacity": 0.35,
                          "zIndex": 3,
                          "map": $scope.mapControl.getGMap()
                        });

                        let fence = {
                              "reference": uid,
                              "polygon": {
                              "safe": safetyLayer,
                              "warn": warningLayer,
                              "danger": dangerLayer
                            },
                            "geojson": {
                              "safe": safety,
                              "warn": warning,
                              "danger": danger
                            },
                            "animals": new Map()
                        };

                        fences.set('fence' + (index++), fence);
                  }
                  else
                  {
                    callback();
                  }
                });
              }

              MongoDB.MongoClient.connect('mongodb://222.116.135.139/virtualfence', (error, database) => {
                findFence(database, function() { database.close() });
              });
      }
    });
  </script>
</body>
</html>
