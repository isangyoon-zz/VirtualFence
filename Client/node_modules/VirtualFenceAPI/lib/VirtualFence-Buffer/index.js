const JSTS              = require('jsts');
const Normalize         = require('geojson-normalize');
const DistanceToDegrees = require('../VirtualFence-Helper').DistanceToDegrees;
const FeatureCollection = require('../VirtualFence-Collection').FeatureCollection;

function Buffer(feature, radius)
{
  let degrees           =  DistanceToDegrees(radius);
  let normalizedFeature =  Normalize(feature);

  let buffer = Normalize(normalizedFeature.features.map((f) => {
    return Process(f, degrees);
  }));

  if (buffer.features.length > 1)
  {
    return buffer;
  }
  else if (buffer.features.length === 1)
  {
    return buffer.features[0];
  }
}

module.exports = Buffer;

function Process(feature, radius)
{
  let reader    = new JSTS.io.GeoJSONReader(),
      writer    = new JSTS.io.GeoJSONWriter();

  let geometry  = reader.read(feature.geometry),
      buffer    = geometry.buffer(radius);

  buffer = writer.write(buffer);

  return {
    "type"        : 'Feature',
    "geometry"    : buffer,
    "properties"  : {}
  };
}
